# Windows Machine Config Bootstrapper

Bootstrapper is the entity responsible for bootstrapping a Windows node. The current scope of this component is to
perform an one shot configuration of the Windows node to ensure that it can be become a worker node. Following are the
jobs that the bootstrapper does:
- Parse the worker ignition file to get the bootstrap kubeconfig
- Ensures that the kubelet gets the correct kubelet config
- Perform CNI configuration
- Run the kubelet as a windows service

Once the bootstrapper has been run and the CSR associated with the Windows node is approved, the Windows 
node will have a taint called `os=Windows:NoSchedule`, only the pods with matching toleration can 
be scheduled onto the Windows node. An example pod spec with the toleration would be:

```
tolerations:
  - key: "os"
    operator: "Equal"
    value: "Windows"
    effect: "NoSchedule"
```

This will be remotely invoked from a Ansible script or can be run locally

## Requirements

- Must be run on Windows server 2019
- Must be run as administrator
- A worker ignition file generated by the cluster must be on disk
- The kubelet you wish to use must be on disk. Currently we support v1.16.2
- If running on AWS, the Windows instance must have the same tags as the other worker nodes in the cluster
- For CNI, the following is required:
  * HNS overlay network has been created
  * A directory with all the [CNI binaries](https://github.com/containernetworking/plugins/releases/download/v0.8.2/cni-plugins-windows-amd64-v0.8.2.tgz)
  * A [CNI v2 or v3 configuration file](https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration)

## Usage
```
make build
```

```
wmcb initialize-kubelet --ignition-file $IGNITION_FILE_PATH --kubelet-path $KUBELET_PATH
wmcb configure-cni --cni-dir $CNI_BIN_DIR --cni-config $CNI_CONFIG
```

`configure-cni` needs to be executed only after `initialize-kubelet` is executed. If `initialize-kubelet` is executed
after `configure-cni` is executed, all the CNI options will be removed. This is to give the user a chance to change
network configuration to something other than CNI after the initial setup.

## Testing

### Windows Machine Config Bootstrapper

#### End to end testing

On an existing Windows instance which is ready to join the cluster, copy the worker ignition file to C:\Windows\Temp\worker.ign, and the kubelet to C:\Windows\Temp\kubelet.exe

On your Linux development machine, build the e2e test binary:
```
make build-wmcb-e2e-test
```
This will build a binary called `wmcb_e2e_test.exe`. Copy this binary to the Windows node and execute it. The expected
output should be as follows:
```
PS C:\wmcb> .\wmcb_e2e_test.exe
PASS
```
If the test passes run the following on your Linux development machine that has access to the cluster where the Windows
node is present:
```
oc get csr
```
Approve the most recent csr by `system:serviceaccount:openshift-machine-config-operator:node-bootstrapper`
```
oc adm certificate approve $CSR_NAME
```
Repeat the above steps for the `system:node:$NODE_NAME` csr which will appear shortly. 

You can now do `oc get nodes`, and see the Windows node has joined the cluster.

#### Unit testing

On your Linux development machine, build the unit test binary:
```
make build-wmcb-unit-test
```
This will build a binary called `wmcb_unit_test.exe`. Copy this binary to a Windows node and execute it. The expected
output should be as follows:
```
PS C:\wmcb> .\wmcb_test.exe
PASS
```

### Ansible

Follow the instructions in `tools/ansible/README.md`, and ensure the playbook completes successfully.
